import Promise from"promise-polyfill";import utils from"./utils";import Icons from"./icons";import handleOption from"./options";import Template from"./template";import Bar from"./bar";import Storage from"./storage";import Lrc from"./lrc";import Controller from"./controller";import Timer from"./timer";import Events from"./events";import List from"./list";let instances=[];class APlayer{constructor(t){if(this.options=handleOption(t),this.container=this.options.container,this.paused=!0,this.playedPromise=Promise.resolve(),this.mode="normal",this.randomOrder=utils.randomOrder(this.options.audio.length),this.container.classList.add("aplayer"),this.options.lrcType&&!this.options.fixed&&this.container.classList.add("aplayer-withlrc"),1<this.options.audio.length&&this.container.classList.add("aplayer-withlist"),utils.isMobile&&this.container.classList.add("aplayer-mobile"),this.arrow=this.container.offsetWidth<=300,this.arrow&&this.container.classList.add("aplayer-arrow"),2===this.options.lrcType||!0===this.options.lrcType){var i=this.container.getElementsByClassName("aplayer-lrc-content");for(let t=0;t<i.length;t++)this.options.audio[t]&&(this.options.audio[t].lrc=i[t].innerHTML)}this.template=new Template({container:this.container,options:this.options,randomOrder:this.randomOrder}),this.options.fixed&&(this.container.classList.add("aplayer-fixed"),this.template.body.style.width=this.template.body.offsetWidth-18+"px"),this.options.mini&&(this.setMode("mini"),this.template.info.style.display="block"),this.template.info.offsetWidth<200&&this.template.time.classList.add("aplayer-time-narrow"),this.options.lrcType&&(this.lrc=new Lrc({container:this.template.lrc,async:3===this.options.lrcType,player:this})),this.events=new Events,this.storage=new Storage(this),this.bar=new Bar(this.template),this.controller=new Controller(this),this.timer=new Timer(this),this.list=new List(this),this.initAudio(),this.bindEvents(),"random"===this.options.order?this.list.switch(this.randomOrder[0]):this.list.switch(0),this.options.autoplay&&this.play(),instances.push(this)}initAudio(){this.audio=document.createElement("audio"),this.audio.preload=this.options.preload;for(let i=0;i<this.events.audioEvents.length;i++)this.audio.addEventListener(this.events.audioEvents[i],t=>{this.events.trigger(this.events.audioEvents[i],t)});this.volume(this.storage.get("volume"),!0)}bindEvents(){this.on("play",()=>{this.paused&&this.setUIPlaying()}),this.on("pause",()=>{this.paused||this.setUIPaused()}),this.on("timeupdate",()=>{var t;this.disableTimeupdate||(this.bar.set("played",this.audio.currentTime/this.duration,"width"),this.lrc&&this.lrc.update(),t=utils.secondToTime(this.audio.currentTime),this.template.ptime.innerHTML!==t&&(this.template.ptime.innerHTML=t))}),this.on("durationchange",()=>{1!==this.duration&&(this.template.dtime.innerHTML=utils.secondToTime(this.duration))}),this.on("loadedmetadata",()=>{this.seek(0),this.paused||this.audio.play()}),this.on("canplay",()=>{var t=this.audio.buffered.length?this.audio.buffered.end(this.audio.buffered.length-1)/this.duration:0;this.bar.set("loaded",t,"width")}),this.on("progress",()=>{var t=this.audio.buffered.length?this.audio.buffered.end(this.audio.buffered.length-1)/this.duration:0;this.bar.set("loaded",t,"width")});let t;this.on("error",()=>{1<this.list.audios.length?(this.notice("An audio error has occurred, player will skip forward in 2 seconds."),t=setTimeout(()=>{this.skipForward(),this.paused||this.play()},2e3)):1===this.list.audios.length&&this.notice("An audio error has occurred.")}),this.events.on("listswitch",()=>{t&&clearTimeout(t)}),this.on("ended",()=>{"none"===this.options.loop?"list"===this.options.order?this.list.index<this.list.audios.length-1?(this.list.switch((this.list.index+1)%this.list.audios.length),this.play()):(this.list.switch((this.list.index+1)%this.list.audios.length),this.pause()):"random"===this.options.order&&(this.randomOrder.indexOf(this.list.index)<this.randomOrder.length-1?(this.list.switch(this.nextIndex()),this.play()):(this.list.switch(this.nextIndex()),this.pause())):"one"===this.options.loop?(this.list.switch(this.list.index),this.play()):"all"===this.options.loop&&(this.skipForward(),this.play())})}setAudio(t){this.hls&&(this.hls.destroy(),this.hls=null);let i=t.type;this.options.customAudioType&&this.options.customAudioType[i]?"[object Function]"===Object.prototype.toString.call(this.options.customAudioType[i])?this.options.customAudioType[i](this.audio,t,this):console.error("Illegal customType: "+i):"hls"===(i=i&&"auto"!==i?i:/m3u8(#|\?|$)/i.exec(t.url)?"hls":"normal")?window.Hls.isSupported()?(this.hls=new window.Hls,this.hls.loadSource(t.url),this.hls.attachMedia(this.audio)):this.audio.canPlayType("application/x-mpegURL")||this.audio.canPlayType("application/vnd.apple.mpegURL")?this.audio.src=t.url:this.notice("Error: HLS is not supported."):"normal"===i&&(this.audio.src=t.url)}theme(t=this.list.audios[this.list.index].theme||this.options.theme,i=this.list.index,s=!0){s&&this.list.audios[i]&&(this.list.audios[i].theme=t),this.template.listCurs[i]&&(this.template.listCurs[i].style.backgroundColor=t),i===this.list.index&&(this.template.pic.style.backgroundColor=t,this.template.played.style.background=t,this.template.thumb.style.background=t,this.template.volume.style.background=t)}seek(t){t=Math.max(t,0),t=Math.min(t,this.duration),this.audio.currentTime=t,this.bar.set("played",t/this.duration,"width"),this.template.ptime.innerHTML=utils.secondToTime(t)}get duration(){return isNaN(this.audio.duration)?0:this.audio.duration}setUIPlaying(){if(this.paused&&(this.paused=!1,this.template.button.classList.remove("aplayer-play"),this.template.button.classList.add("aplayer-pause"),this.template.button.innerHTML="",setTimeout(()=>{this.template.button.innerHTML=Icons.pause},100),this.template.skipPlayButton.innerHTML=Icons.pause),this.timer.enable("loading"),this.options.mutex)for(let t=0;t<instances.length;t++)this!==instances[t]&&instances[t].pause()}play(){this.setUIPlaying();var t=this.audio.play();t&&t.catch(t=>{console.warn(t),"NotAllowedError"===t.name&&this.setUIPaused()})}setUIPaused(){this.paused||(this.paused=!0,this.template.button.classList.remove("aplayer-pause"),this.template.button.classList.add("aplayer-play"),this.template.button.innerHTML="",setTimeout(()=>{this.template.button.innerHTML=Icons.play},100),this.template.skipPlayButton.innerHTML=Icons.play),this.container.classList.remove("aplayer-loading"),this.timer.disable("loading")}pause(){this.setUIPaused(),this.audio.pause()}switchVolumeIcon(){.95<=this.volume()?this.template.volumeButton.innerHTML=Icons.volumeUp:0<this.volume()?this.template.volumeButton.innerHTML=Icons.volumeDown:this.template.volumeButton.innerHTML=Icons.volumeOff}volume(t,i){return t=parseFloat(t),isNaN(t)||(t=Math.max(t,0),t=Math.min(t,1),this.bar.set("volume",t,"height"),i||this.storage.set("volume",t),this.audio.volume=t,this.audio.muted&&(this.audio.muted=!1),this.switchVolumeIcon()),this.audio.muted?0:this.audio.volume}on(t,i){this.events.on(t,i)}toggle(){this.template.button.classList.contains("aplayer-play")?this.play():this.template.button.classList.contains("aplayer-pause")&&this.pause()}switchAudio(t){this.list.switch(t)}addAudio(t){this.list.add(t)}removeAudio(t){this.list.remove(t)}destroy(){instances.splice(instances.indexOf(this),1),this.pause(),this.container.innerHTML="",this.audio.src="",this.timer.destroy(),this.events.trigger("destroy")}setMode(t="normal"){"mini"===(this.mode=t)?this.container.classList.add("aplayer-narrow"):"normal"===t&&this.container.classList.remove("aplayer-narrow")}notice(t,i=2e3,s=.8){this.template.notice.innerHTML=t,this.template.notice.style.opacity=s,this.noticeTime&&clearTimeout(this.noticeTime),this.events.trigger("noticeshow",{text:t}),i&&(this.noticeTime=setTimeout(()=>{this.template.notice.style.opacity=0,this.events.trigger("noticehide")},i))}prevIndex(){var t;return 1<this.list.audios.length?"list"===this.options.order?this.list.index-1<0?this.list.audios.length-1:this.list.index-1:"random"===this.options.order?0===(t=this.randomOrder.indexOf(this.list.index))?this.randomOrder[this.randomOrder.length-1]:this.randomOrder[t-1]:void 0:0}nextIndex(){var t;return 1<this.list.audios.length?"list"===this.options.order?(this.list.index+1)%this.list.audios.length:"random"===this.options.order?(t=this.randomOrder.indexOf(this.list.index))===this.randomOrder.length-1?this.randomOrder[0]:this.randomOrder[t+1]:void 0:0}skipBack(){this.list.switch(this.prevIndex())}skipForward(){this.list.switch(this.nextIndex())}static get version(){return APLAYER_VERSION}}export default APlayer;